include ../config.mk
PACKAGES = openal-soft ogg vorbis alure zlib physfs lua lua-cjson glfw bullet
GENERATED = $(PACKAGES)

HERE = $(shell pwd)
ROOT = $(shell cd .. && pwd)

all: .gitignore $(PACKAGES)

clean:
	rm -f .gitignore
	rm -fr $(PACKAGES)

.PHONY: all clean

.gitignore:
	echo '# FILE IS GENERATED BY MAKE - DO NOT EDIT' > $@
	for file in $(GENERATED) ; do \
		echo /$$file >> $@ ; \
	done

define get-src =
	cd $(ROOT)/src && $(MAKE) $@
endef

define build-cmake =
	$(get-src)
	rm -rf $@
	mkdir $@
	cd $@ && cmake $(ROOT)/src/$@ $(CMAKE_ARGS) -C$(HERE)/$@.cmake
	cd $@ && $(MAKE)
endef

define build-autotools =
	$(get-src)
	rm -rf $@
	cp -R $(ROOT)/src/$@ $@
	cd $@ && ./configure $(AUTOTOOLS_ARGS)
	cd $@ && $(MAKE)
endef

openal-soft:
	$(build-cmake)

ogg:
	$(build-autotools)

vorbis: AUTOTOOLS_ARGS += "OGG_CFLAGS=-I$(HERE)/ogg/include"
vorbis: AUTOTOOLS_ARGS += "OGG_LIBS=-L$(HERE)/ogg/src/.libs"
vorbis: ogg
	$(build-autotools)

alure: openal-soft vorbis
	$(build-cmake)

zlib:
	$(build-cmake)

physfs: zlib
	$(build-cmake)

lua:
	$(get-src)
	rm -rf $@
	cp -R $(ROOT)/src/$@ $@
	cd $@ && $(MAKE) PLAT=generic \
					 "CC=$(CC)" \
					 "CFLAGS=$(CFLAGS)" \
					 "LDFLAGS=$(LDFLAGS)" \
					 "AR=$(AR) rcu" \
					 "RANLIB=$(RANLIB)"

lua-cjson:
	$(build-cmake)

glfw:
	$(build-cmake)

bullet:
	$(build-cmake)
